# Document Generation System - Architecture & Implementation

## Overview

This system generates multiple export documents (Excel/Word) from a single data entry point (master dispatch form). All templates preserve their original formatting, layout, headers, and merged cells.

---

## Template Parsing & Mapping Strategy

### 1. **Template Analysis Approach**

#### For Excel Templates (.xlsx, .xls):
- **Load template** using PHPSpreadsheet
- **Identify fixed cells**: Headers, labels, static text (these remain unchanged)
- **Identify data cells**: Cells that need to be populated with dynamic data
- **Identify repeating rows**: Rows that repeat for each truck/dispatch
- **Preserve formatting**: Cell styles, fonts, colors, borders, merged cells, formulas

#### For Word Templates (.docx):
- **Load template** using PHPWord
- **Identify placeholders**: Text placeholders like `{ORDER_NO}`, `{PARTY_NAME}`, etc.
- **Identify tables**: Tables that need row duplication for multiple trucks
- **Preserve formatting**: Fonts, styles, paragraph formatting, table styles

---

### 2. **Mapping Configuration**

Each document type has a **mapping configuration file** that defines:

```php
[
    'template_file' => 'Formats/Commercial Tax Invoice.xlsx',
    'type' => 'excel', // or 'word'
    'output_filename_pattern' => 'Commercial_Invoice_{ORDER_NO}_{DATE}.xlsx',
    
    // Single-value mappings (order/party/company data)
    'single_value_mappings' => [
        'B5' => 'order.order_no',           // Cell B5 = order.order_no
        'C7' => 'party.name',                // Cell C7 = party.name
        'D9' => 'company.gst_number',        // Cell D9 = company.gst_number
        // ... more mappings
    ],
    
    // Repeating row mappings (for truck-wise data)
    'repeating_rows' => [
        'start_row' => 15,                   // Row where truck data starts
        'template_row' => 15,                 // Template row to duplicate
        'mappings' => [
            'A15' => 'dispatch.vehicle_no',  // Column A = vehicle number
            'B15' => 'dispatch.dispatch_date',// Column B = dispatch date
            'C15' => 'dispatch.qty_trucks',  // Column C = quantity
            // ... more mappings
        ]
    ],
    
    // Word-specific: placeholder replacements
    'placeholders' => [
        '{ORDER_NO}' => 'order.order_no',
        '{PARTY_NAME}' => 'party.name',
        '{COMPANY_NAME}' => 'company.name',
        // ... more placeholders
    ],
    
    // Word-specific: table row duplication
    'tables' => [
        [
            'table_index' => 0,               // First table in document
            'template_row' => 1,              // Row to duplicate
            'mappings' => [
                'column_0' => 'dispatch.vehicle_no',
                'column_1' => 'dispatch.dispatch_date',
                // ... more columns
            ]
        ]
    ]
]
```

---

### 3. **Data Source Structure**

Data is collected from:
- **Order**: order_no, order_date, product_name, order_qty_trucks
- **Party**: name, address, contact_person, phone, email, gst_number (if exists)
- **Company**: name, address, gst_number, pan_number, contact_person
- **Dispatches**: Array of dispatch records (vehicle_no, dispatch_date, dispatch_qty_trucks)

---

### 4. **Generation Process**

#### Step 1: Load Template
```php
$template = DocumentGeneratorService::loadTemplate('Commercial Tax Invoice.xlsx');
```

#### Step 2: Map Data
```php
$data = [
    'order' => $order->toArray(),
    'party' => $party->toArray(),
    'company' => $company->toArray(),
    'dispatches' => array_map(fn($d) => $d->toArray(), $dispatches)
];

$mapped = DocumentGeneratorService::mapData($template, $data, $mappingConfig);
```

#### Step 3: Generate Output
```php
$outputFile = DocumentGeneratorService::generateOutput(
    $template,
    $mapped,
    $mappingConfig,
    $outputPath
);
```

---

### 5. **File Generation Options**

#### Option A: One File Per Truck
- Generate separate file for each dispatch
- Filename: `Commercial_Invoice_ORD001_Truck1.xlsx`

#### Option B: Consolidated File
- All trucks in one file (multiple rows)
- Filename: `Commercial_Invoice_ORD001.xlsx`

**Configuration:**
```php
'output_mode' => 'consolidated', // or 'per_truck'
```

---

### 6. **Document Types**

1. **SCOMET FORMAT** (.docx) - Word document
2. **Beneficiary COO** (.docx) - Word document  
3. **Bilty/Bill of Lading** (.docx) - Word document
4. **Commercial Tax Invoice** (.xlsx) - Excel document
5. **SAFTA Invoice** (.xls) - Excel document

---

### 7. **Logging**

All generated documents are logged:
- Order ID
- Dispatch ID(s)
- Document type
- Generated file path
- Generation timestamp
- Generated by (user)

---

## Implementation Files

1. **Mapping Configurations**: `config/document_mappings/`
   - `commercial_tax_invoice.php`
   - `scomet_format.php`
   - `beneficiary_coo.php`
   - `bilty.php`
   - `safta_invoice.php`

2. **Services**: `src/Services/`
   - `DocumentGeneratorService.php` - Main service
   - `ExcelDocumentService.php` - Excel-specific
   - `WordDocumentService.php` - Word-specific

3. **Controller**: `src/Controllers/DocumentController.php`
   - API endpoints for document generation

4. **Database**: Migration for `document_generation_logs` table

5. **UI**: Button in order detail page to generate documents

---

## Next Steps

1. Analyze each template to identify exact cell locations/placeholders
2. Create mapping configuration for each document
3. Implement Excel generation service
4. Implement Word generation service
5. Create API endpoints
6. Add UI for document generation
7. Test with sample data
